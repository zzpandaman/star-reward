# 积分记录域设计与实现

## 一、遵循 project-structure.mdc 的路径与职责

| 层级 | 路径 | 职责 |
|------|------|------|
| Domain | `domain/pointrecord/model/entity/` | PointRecordBO |
| Domain | `domain/pointrecord/model/constant/` | PointRecordConstants |
| Domain | `domain/pointrecord/model/valueobject/` | PointRecordType |
| Domain | `domain/pointrecord/repository/` | PointRecordRepository 接口 |
| Application | `application/assembler/` | PointRecordAssembler.entityToResponse |
| Application | `application/service/` | PointRecordApplicationService 编排 |
| Infrastructure | `infrastructure/persistence/converter/` | PointRecordConverter.doToEntity / entityToDo |
| Infrastructure | `infrastructure/persistence/repository/` | PointRecordRepositoryImpl |
| Interfaces | `interfaces/rest/controller/` | Controller |
| Interfaces | `interfaces/rest/dto/response/` | PointRecordResponse（已存在） |

**转换命名规范**（project-structure 表）：`entityToResponse`、`doToEntity`、`entityToDo`

**Application 职责**：编排 Domain Service 与 Repository，不包含业务规则。积分记录创建由 TaskExecutionApplicationService、ExchangeService 编排调用 Repository。

---

## 二、底表设计

新增 `db/migration/V3__reward_add_point_record.sql`：

```sql
CREATE TABLE `reward_point_record` (
  `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '自增主键',
  `record_no` varchar(32) NOT NULL COMMENT '记录编号',
  `point_type` varchar(16) NOT NULL COMMENT '类型。EARN-获取 SPEND-消耗',
  `amount` decimal(20,6) UNSIGNED NOT NULL COMMENT '积分数量',
  `belong_to` varchar(32) NOT NULL COMMENT '所属人账号',
  `belong_to_id` bigint(20) UNSIGNED NOT NULL COMMENT '所属人ID',
  `related_id` varchar(64) NULL COMMENT '关联业务ID（任务实例编号/购买记录编号）',
  `description` varchar(500) NULL COMMENT '描述',
  `create_by` varchar(32) NOT NULL COMMENT '创建人账号',
  `create_by_id` bigint(20) UNSIGNED NOT NULL COMMENT '创建人ID',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `udx_record_no` (`record_no`) USING BTREE,
  KEY `idx_belong_to_id` (`belong_to_id`) USING BTREE,
  KEY `idx_create_time` (`create_time`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARACTER SET=utf8mb4 COLLATE=utf8mb4_general_ci COMMENT='积分记录表';
```

---

## 三、Domain 层

- **PointRecordConstants**：`RECORD_NO_PREFIX`、`TYPE_EARN`、`TYPE_SPEND`
- **PointRecordType**：枚举 EARN/SPEND（值对象）
- **PointRecordBO**：充血工厂 `createEarn(...)`、`createSpend(...)`
- **PointRecordRepository**：`save(PointRecordBO)`、`findById(Long id)`、`findByBelongToId(Long userId)`、`findByBelongToIdAndType(Long userId, PointRecordType type)`

**无** PointRecordCreationService：直接由 Application/Domain Service 调用 Repository.save。

---

## 四、Infrastructure 层

1. Flyway 执行 V3 后，在 `generatorConfig.xml` 新增 `reward_point_record`，运行 MyBatis Generator
2. **PointRecordConverter**：`doToEntity(RewardPointRecordDO)`、`entityToDo(PointRecordBO)`
3. **PointRecordRepositoryImpl**：实现 `PointRecordRepository`

---

## 五、各层联动

### 5.1 任务完成（积分获取）

**TaskExecutionApplicationService**（Application 层）注入 `PointRecordRepository`，在 `addUserPoints` 后：

```java
PointRecordBO earnRecord = PointRecordBO.createEarn(
    RewardNoGenerator.generate(PointRecordConstants.RECORD_NO_PREFIX),
    result.getTotalPoints(), user.getUserNo(), user.getUserId(),
    instance.getInstanceNo(), "完成任务: " + instance.getName(), now);
pointRecordRepository.save(earnRecord);
```

### 5.2 商品兑换（积分消耗）

**ExchangeService**（Domain Service）注入 `PointRecordRepository`：

1. 方法开头生成 `purchaseNo`
2. 扣积分后、`createPurchaseRecord` 前，保存消耗记录：
```java
PointRecordBO spendRecord = PointRecordBO.createSpend(
    RewardNoGenerator.generate(PointRecordConstants.RECORD_NO_PREFIX),
    pointsRequired, userNo, userId, purchaseNo, "兑换商品: " + product.getName(), now);
pointRecordRepository.save(spendRecord);
```
3. `createPurchaseRecord` 改为接收 `purchaseNo` 参数

---

## 六、Application 与 Interfaces

### 6.1 PointRecordApplicationService

- `listUserPointRecords(PointRecordType type)`：当前用户积分记录，可选按 type 过滤
- `getPointRecordById(Long id)`：单条详情，校验 belongToId=当前用户
- 编排：`CurrentUserContext` + `PointRecordRepository`

### 6.2 PointRecordAssembler（application/assembler）

- `entityToResponse(PointRecordBO)`：BO → PointRecordResponse，type 映射 EARN→earn、SPEND→spend

### 6.3 查询入参

与现有 `getUserInventory`、`getTaskExecutions` 一致，无 Request DTO，无 Command。可选 `type` 通过 `@RequestParam` 传入。

### 6.4 REST 接口

在 **UserController** 扩展：
- `GET /api/reward/user/point-records?type=earn|spend`：列表
- `GET /api/reward/user/point-records/{id}`：单条详情

---

## 6.5 前端跳转兼容：补充任务执行/购买记录详情接口

前端从积分记录列表点击某条，根据 `type` + `relatedId` 跳转详情页：
- **earn**：`relatedId` = instance_no → 任务执行详情
- **spend**：`relatedId` = purchase_no → 购买记录详情

需补充以下**缺失的**单条详情接口：

| 接口 | 路径 | 说明 |
|------|------|------|
| 任务执行详情 | `GET /api/reward/task-executions/by-no/{instanceNo}` | 按实例编号查询，校验 executeById=当前用户 |
| 购买记录详情 | `GET /api/reward/purchase-record/by-no/{purchaseNo}` | 按购买编号查询，校验 purchaseById=当前用户 |

**前端跳转流程**：
```
积分记录列表 → 点击某条（type + relatedId）
    → type=earn  → GET /task-executions/by-no/{relatedId} → 任务执行详情页
    → type=spend → GET /purchase-record/by-no/{relatedId}  → 购买记录详情页
```

**实现要点**：
- **TaskExecutionApplicationService**：新增 `getTaskExecutionByInstanceNo(String instanceNo)`，复用现有 `toResponse`
- **TaskExecutionController**：新增 `GET /by-no/{instanceNo}`
- **PurchaseRecordApplicationService**：新增 `getPurchaseRecordByPurchaseNo(String purchaseNo)`
- **PurchaseRecordAssembler**：新增 `entityToResponse(PurchaseRecordBO)` 用于详情
- **PurchaseRecordResponse**：新建 DTO（id, purchaseNo, productNo, name, description, price, quantity, createTime 等）
- **PurchaseRecordController**：新增 `GET /by-no/{purchaseNo}`

---

## 七、数据流（符合 project-structure）

```
HTTP GET /point-records
    ↓
UserController
    ↓
PointRecordApplicationService.listUserPointRecords
    ↓
PointRecordRepository.findByBelongToId
    ↓
PointRecordAssembler.entityToResponse
    ↓
Result<PageResponse<PointRecordResponse>>
```

---

## 八、实现顺序

1. Flyway V3 + generatorConfig + MyBatis Generator
2. Domain：Constants、PointRecordType、PointRecordBO、PointRecordRepository
3. Infrastructure：PointRecordConverter、PointRecordRepositoryImpl
4. 联动：TaskExecutionApplicationService、ExchangeService
5. Application：PointRecordApplicationService、PointRecordAssembler
6. Interfaces：UserController 扩展（列表 + 单条详情）
7. **前端跳转兼容**：任务执行详情、购买记录详情
   - PurchaseRecordResponse、PurchaseRecordAssembler.entityToResponse
   - TaskExecutionApplicationService.getTaskExecutionByInstanceNo
   - PurchaseRecordApplicationService.getPurchaseRecordByPurchaseNo
   - 两个 Controller 新增 GET /by-no/{no}
