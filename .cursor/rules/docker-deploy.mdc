---
description: Docker 部署配置规范
alwaysApply: true
---

# Docker 部署配置

## 部署方式

- **本地开发**: 使用部署脚本手动构建部署
- **生产环境**: GitHub Actions 自动构建推送镜像

## 本地开发命令

### 后端服务管理

```bash
cd /Users/cdmac14013/docker/star-deploy/backend

./deploy-backend.sh deploy local   # 构建部署
./deploy-backend.sh restart local  # 重启
./deploy-backend.sh stop           # 停止
./deploy-backend.sh logs star-reward
./deploy-backend.sh status
```

### 一键部署

```bash
cd /Users/cdmac14013/docker/star-deploy
./deploy-all.sh local
```

## 健康检查

```bash
curl http://localhost/api/sso/health
curl http://localhost/api/reward/health
curl http://localhost/health
```

## 打包要求

```bash
cd service
mvn clean package spring-boot:repackage -DskipTests
```

## 日志配置

- `logback-spring.xml` 按环境输出
- Docker 环境日志挂载到宿主机 `/app/logs`

---

## GitHub Actions 自动部署

### 触发条件

- push 到 main 分支
- 手动触发 (workflow_dispatch)

### 工作流程

```
push main → 构建 star-common → 构建 star-sso api-client → 构建 star-reward JAR
          → 构建 Docker 镜像 → 推送到 Registry → SSH 重启服务
```

### GitHub Secrets

```
REGISTRY_URL    = <服务器IP>   # 仅主机名/IP，不要 http://、:5000；nginx 80 端口代理
REGISTRY_USER   = admin
REGISTRY_PASS   = <密码>
SERVER_HOST     = <服务器IP>
SERVER_USER     = <SSH用户>
SERVER_SSH_KEY  = <SSH私钥>
```

### Workflow 文件

`.github/workflows/deploy.yml`

---

## 服务器运维

### Portainer

访问 `http://服务器IP/portainer/` 管理容器（通过 nginx 代理）

- 首次初始化需 5 分钟内完成，超时执行 `docker restart portainer`
- 创建用户后若超时，刷新重试或重启 portainer

### 手动部署

```bash
ssh user@server << 'EOF'
cd /opt/star-deploy/backend
docker login localhost:5000 -u admin -p <password>
docker pull localhost:5000/star-reward:latest
docker compose --env-file .env.prod up -d star-reward
EOF
```

### Nginx 配置更新（如 413 Request Entity Too Large）

```bash
scp /path/to/star-deploy/nginx/conf.d/backend.conf user@server:/opt/star-deploy/nginx/conf.d/
ssh user@server "docker exec star-nginx nginx -s reload"
```

### 版本回滚

```bash
# 查看版本（服务器本机用 localhost，远程用 $SERVER_HOST）
curl -u admin:password http://localhost/v2/star-reward/tags/list

# 回滚
cd /opt/star-deploy/backend
docker pull localhost:5000/star-reward:<commit-sha>
docker compose --env-file .env.prod up -d star-reward
```

### 日志查看

```bash
# Portainer 或命令行
docker logs -f star-reward
# 或挂载目录
tail -f /var/log/star/star-reward/star-reward-service.log
```
