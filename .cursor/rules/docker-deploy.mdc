---
description: Docker 部署配置规范
alwaysApply: true
---

# Docker 部署配置

## 部署方式

- **本地开发**: 使用部署脚本手动构建部署
- **生产环境**: GitHub Actions 自动构建推送镜像

## 本地开发命令

### 后端服务管理

```bash
cd /Users/cdmac14013/docker/star-deploy/backend

./deploy-backend.sh deploy local   # 构建部署
./deploy-backend.sh restart local  # 重启
./deploy-backend.sh stop           # 停止
./deploy-backend.sh logs star-reward
./deploy-backend.sh status
```

### 一键部署

```bash
cd /Users/cdmac14013/docker/star-deploy
./deploy-all.sh local
```

## 健康检查

```bash
curl http://localhost/api/sso/health
curl http://localhost/api/reward/health
curl http://localhost/health
```

## 打包要求

```bash
cd service
mvn clean package spring-boot:repackage -DskipTests
```

## 日志配置

- `logback-spring.xml` 按环境输出
- Docker 环境日志挂载到宿主机 `/app/logs`

---

## GitHub Actions 自动部署

### 触发条件

- push 到 main 分支
- 手动触发 (workflow_dispatch)

### 工作流程

```
push main → mvn clean install (star-common → star-sso → star-reward)
          → 构建 Docker 镜像 → 推送到 Registry → SSH 重启服务
```

### GitHub Secrets

```
REGISTRY_URL    = <服务器IP>   # 仅主机名/IP，不要 http://、:5000；nginx 80 端口代理
REGISTRY_USER   = admin
REGISTRY_PASS   = <密码>
SERVER_HOST     = <服务器IP>
SERVER_USER     = <SSH用户>
SERVER_SSH_KEY  = <SSH私钥>
```

### Workflow 文件

`.github/workflows/deploy.yml`

---

## 服务器运维

### Portainer

访问 `http://服务器IP/portainer/` 管理容器（通过 nginx 代理）

- 首次初始化需 5 分钟内完成，超时执行 `docker restart portainer`
- 创建用户后若超时，刷新重试或重启 portainer

### 手动部署

```bash
ssh user@server << 'EOF'
cd /opt/star-deploy/backend
docker login localhost:5000 -u admin -p <password>
docker pull localhost:5000/star-reward:latest
docker compose --env-file .env.prod up -d star-reward
EOF
```

### Nginx 配置更新（如 413）

`cd ~/docker/star-deploy && ./deploy-nginx-config.sh`（依赖 ~/.ssh/config Host，默认 myServer）

若仍 413：前有阿里云 SLB/WAF 时，在控制台提高请求体大小限制。

### 版本回滚

```bash
curl -u admin:password http://localhost/v2/star-reward/tags/list
cd /opt/star-deploy/backend
docker pull localhost:5000/star-reward:<commit-sha>
docker compose --env-file .env.prod up -d star-reward
```

### 日志查看

```bash
# Portainer 或命令行
docker logs -f star-reward
# 或挂载目录（服务器）
tail -f /opt/star-deploy/logs/star-reward/star-reward-service.log
```

### MySQL 在宿主机时

- 后端使用 `network_mode: host`，DB_URL 用 `127.0.0.1`
- 需在 MySQL 创建 `root@127.0.0.1` 并授权 star_core
