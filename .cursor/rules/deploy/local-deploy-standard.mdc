---
description: star-deploy-local 设计文档与规范
globs: "**/star-deploy-local/**"
alwaysApply: false
---

# star-deploy-local 设计规范

## 目录结构

```
star-deploy-local/
├── deploy-all.sh           # 一键全量部署
├── docker-compose.yml      # 仅 nginx
├── .env.local              # 根 compose 环境变量
├── backend/
│   ├── deploy-backend.sh   # 后端构建部署（star-sso + star-reward）
│   ├── docker-compose.yml # 后端服务 compose
│   ├── paths.conf          # CODE_DIR、DEPLOY_DIR、LOG_DIR、MAVEN_REPO
│   ├── .env.local          # 数据库、JWT 等
│   └── apps/{star-sso,star-reward}/  # JAR + Dockerfile
├── frontend/
│   └── deploy-frontend.sh # 前端构建并同步到 nginx/html/star
├── nginx/
│   ├── conf.d/backend.conf # 精简配置：api + frontend + health
│   └── html/star/          # 前端静态文件
└── logs/                   # 日志挂载目录
```

## 脚本职责

| 脚本 | 职责 |
|------|------|
| deploy-all.sh | 创建网络 → deploy-backend → deploy-frontend → nginx up |
| deploy-backend.sh | 构建 star-common/star-sso/star-reward → 复制 JAR → docker compose up |
| deploy-frontend.sh | npm build → 同步 dist 到 nginx/html/star → nginx reload |

## 配置约定

- **paths.conf**：DEPLOY_DIR 必须指向 star-deploy-local 绝对路径
- **.env.local**：根目录仅 LOG_DIR；backend 含 DB_*、JWT_SECRET、SSO_SERVICE_URL
- **nginx**：仅 /api/sso/、/api/reward/、/star、/health，无 registry/portainer

## 单服务部署/启停速查

| 服务 | 部署 | 启动 | 停止 | 重启 |
|------|------|------|------|------|
| nginx | `docker compose up -d` | 同上 | `docker compose down` | `docker compose restart nginx` |
| star-sso | `deploy-backend.sh deploy` | 随 backend up | `docker compose -f backend/ down` | `docker compose -f backend/ restart star-sso` |
| star-reward | 同上 | 同上 | 同上 | `restart star-reward` |
| star-reward-app | `deploy-frontend.sh deploy` | 无独立进程 | - | `deploy-frontend.sh sync` + nginx reload |

## 与 local-env-architecture 衔接

- 本地部署仅用 star-deploy-local，不与 star-deploy-server 混用
- 路径引用统一使用 star-deploy-local 绝对路径或 paths.conf 变量
